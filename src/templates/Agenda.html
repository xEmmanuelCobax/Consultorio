{% extends 'Vertical-navbar.html' %}



{% block title %}
MediLink - Agenda
{% endblock %}

{% block head %}
<!--JQuery-->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
<!-- Scripts de Bootstrap y jQuery -->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
<!-- OTRAS LIBRERIAS QUE NECESITES IMPORTAR -->
<!-- Bootstrap datepicker CSS -->
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />
<!-- Bootstrap datepicker JS-->
<script
src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

<style>
    .calendar-container {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .calendar-day {
        cursor: pointer;
    }

    .calendar-day:hover {
        background-color: #e9ecef;
    }

    .calendar-day.has-appointment {
        background-color: #cfe2ff;
    }

    .calendar-day.selected {
        background-color: #0d6efd;
        color: white;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid main-content">
    di
    <div class="row">
        <div class="col-md-9">
            <div class="calendar-container p-3 mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 id="currentMonthYear"></h2>
                    <div>
                        <button id="prevMonth" class="btn btn-outline-primary"><i
                                class="fas fa-chevron-left"></i></button>
                        <button id="nextMonth" class="btn btn-outline-primary"><i
                                class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Lun</th>
                            <th>Mar</th>
                            <th>Mié</th>
                            <th>Jue</th>
                            <th>Vie</th>
                            <th>Sáb</th>
                            <th>Dom</th>
                        </tr>
                    </thead>
                    <tbody id="calendarBody">
                        <!-- Calendar days will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Detalles de la Cita</h5>
                    <div id="appointmentDetails">
                        <!-- Appointment details will be shown here -->
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button id="addAppointment" class="btn btn-primary" type="button">Agregar Cita</button>
                        <button id="modifyAppointment" class="btn btn-secondary" type="button" disabled>Modificar
                            Cita</button>
                        <button id="deleteAppointment" class="btn btn-danger" type="button" disabled>Eliminar
                            Cita</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ||||||||||||||||| -->
    <div class="row">
        <div class="col-8">
            <input type="date" id="fecha-test" class="form-control">
            <button type="button" class="btn btn-danger" id="boton-test">Llamar</button>
            <textarea name="" id="texto" class="form-control"></textarea>
        </div>

    </div>

    <div class="row">
        <div class="col-8">
            <div data-date="12/03/2012" id="select-fecha"></div>
        </div>

    </div>

</div>

<div class="modal fade" id="modalAgregarCita" tabindex="-1" aria-labelledby="modalAgregarPacienteLabel"
aria-hidden="true">
<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h1 class="modal-title h5" id="modalAgregarCitaLabel">Agregar Cita</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <!-- Agregar cita -->
            <form action="/agregar_cita" method="post">
                <div class="input-group flex-nowrap mb-2">
                    <label for="paciente" class="input-group-text">Nombre</label>
                    <select class="form-select" name="paciente" id="paciente">
                        <option value="-1" selected>----- Elige una opción -----</option>
                        {% if lista_pacientes %}
                        {% for paciente in lista_pacientes %}
                        <option value="{{paciente['ID_paciente']}}">{{paciente['Nombres']}}
                            {{paciente['Apellido_paterno']}}
                            {{paciente['Apellido_materno']}}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div class="input-group flex-nowrap mb-2">
                    <label for="motivo" class="input-group-text">Motivo</label>
                    <textarea class="form-control" id="motivo" rows="3" name="motivo"></textarea>
                </div>
                <div class="input-group flex-nowrap mb-2">
                    <label for="fecha" class="input-group-text">Fecha</label>
                    <input type="date" name="fecha" id="fecha" class="form-control">
                </div>
                <div class="input-group flex-nowrap mb-2">
                    <label for="hora" class="input-group-text">Hora</label>
                    <input type="time" name="hora" id="hora" class="form-control" min="07:00" max="24:00"
                        step="1800" value="12:00">
                </div>
                <div class="input-group flex-nowrap mb-2">
                    <label for="doctor" class="input-group-text">Doctor asignado</label>
                    <select class="form-select" name="doctor" id="doctor">
                        <option value="-1" selected>----- Elige una opción -----</option>
                        {% if lista_doctores %}
                        {% for doctor in lista_doctores %}
                        <option value="{{doctor['ID_doctor']}}">Dr. {{doctor['Nombres']}}
                            {{doctor['Apellido_paterno']}}
                            {{doctor['Apellido_materno']}}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div class="input-group flex-nowrap mb-2">
                    <input type="submit" name="submit" id="submit" class="form-control">
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        let currentDate = new Date();
        let appointments = [];
        function updateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay() === 0 ? 7 : firstDay.getDay(); // Adjust for Monday start

            $('#currentMonthYear').text(`${currentDate.toLocaleString('default', { month: 'long' })} ${year}`);

            let calendarHTML = '';
            let dayCount = 1;
            for (let i = 0; i < 6; i++) {
                calendarHTML += '<tr>';
                for (let j = 1; j <= 7; j++) {
                    if (i === 0 && j < startingDay) {
                        calendarHTML += '<td></td>';
                    } else if (dayCount > daysInMonth) {
                        calendarHTML += '<td></td>';
                    } else {
                        const date = new Date(year, month, dayCount);
                        const hasAppointment = appointments.some(app => {
                            const appDate = new Date(app.date);
                            return appDate.getFullYear() === year && appDate.getMonth() === month && appDate.getDate() === dayCount;
                        });
                        const classes = ['calendar-day'];
                        if (hasAppointment) classes.push('has-appointment');
                        calendarHTML += `<td class="${classes.join(' ')}" data-date="${date.toISOString().split('T')[0]}">${dayCount}</td>`;
                        dayCount++;
                    }
                }
                calendarHTML += '</tr>';
                if (dayCount > daysInMonth) break;
            }
            $('#calendarBody').html(calendarHTML);
        }

        $('#prevMonth').click(function () {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendar();
        });

        $('#nextMonth').click(function () {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendar();
        });

        $('#calendarBody').on('click', '.calendar-day', function () {
            $('.calendar-day').removeClass('selected');
            $(this).addClass('selected');
            const selectedDate = $(this).data('date');
            showAppointments(selectedDate);
        });

        function showAppointments(date) {
            const dayAppointments = appointments.filter(app => app.date === date);
            let detailsHTML = '<ul class="list-group">';
            dayAppointments.forEach(app => {
                detailsHTML += `
                    <li class="list-group-item">
                        <strong>${app.time}</strong> - ${app.patientName}<br>
                        Motivo: ${app.reason}<br>
                        Estado: ${getStatusText(app.status)}
                    </li>
                `;
            });
            detailsHTML += '</ul>';
            $('#appointmentDetails').html(detailsHTML);
            $('#modifyAppointment, #deleteAppointment').prop('disabled', dayAppointments.length === 0);
        }

        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'En espera';
                case 'completed': return 'Finalizado';
                case 'cancelled': return 'Cancelado';
                default: return status;
            }
        }

        $('#addAppointment').click(function () {
            const selectedDate = $('.calendar-day.selected').data('date');
            if (selectedDate) {
                $('#appointmentId').val('');
                $('#fecha').val(selectedDate);
                $('#appointmentTime').val('');
                $('#patientName').val('');
                $('#appointmentReason').val('');
                $('#appointmentStatus').val('pending');
                $('#prescription').val('');
                $('#prescriptionContainer').hide();
                $('#modalAgregarCita').modal('show');
            } else {
                alert('Por favor, seleccione una fecha en el calendario.');
            }
        });

        $('#appointmentStatus').change(function () {
            if ($(this).val() === 'completed') {
                $('#prescriptionContainer').show();
            } else {
                $('#prescriptionContainer').hide();
            }
        });

        $('#saveAppointment').click(function () {
            const id = $('#appointmentId').val();
            const newAppointment = {
                id: id || Date.now().toString(),
                date: $('#appointmentDate').val(),
                time: $('#appointmentTime').val(),
                patientName: $('#patientName').val(),
                reason: $('#appointmentReason').val(),
                status: $('#appointmentStatus').val(),
                prescription: $('#prescription').val()
            };

            if (id) {
                // Modify existing appointment
                const index = appointments.findIndex(app => app.id === id);
                if (index !== -1) {
                    appointments[index] = newAppointment;
                }
            } else {
                // Add new appointment
                appointments.push(newAppointment);
            }

            $('#appointmentModal').modal('hide');
            updateCalendar();
            showAppointments(newAppointment.date);
        });

        $('#modifyAppointment').click(function () {
            const selectedDate = $('.calendar-day.selected').data('date');
            const dayAppointments = appointments.filter(app => app.date === selectedDate);
            if (dayAppointments.length > 0) {
                const appointment = dayAppointments[0]; // For simplicity, edit the first appointment
                $('#appointmentId').val(appointment.id);
                $('#appointmentDate').val(appointment.date);
                $('#appointmentTime').val(appointment.time);
                $('#patientName').val(appointment.patientName);
                $('#appointmentReason').val(appointment.reason);
                $('#appointmentStatus').val(appointment.status);
                $('#prescription').val(appointment.prescription || '');
                if (appointment.status === 'completed') {
                    $('#prescriptionContainer').show();
                } else {
                    $('#prescriptionContainer').hide();
                }
                $('#appointmentModal').modal('show');
            }
        });

        $('#deleteAppointment').click(function () {
            const selectedDate = $('.calendar-day.selected').data('date');
            appointments = appointments.filter(app => app.date !== selectedDate);
            updateCalendar();
            showAppointments(selectedDate);
        });

        updateCalendar();



        $('#boton-test').click(function () {
            const fecha = $('#fecha-test').val();
            
            const date = new Date(fecha);
            const year = date.getFullYear()
            const month = date.getMonth() + 1
            const day = date.getDate() + 1
            console.log(fecha)
            request(year, month, day)
        });
        //LLamada a APi
        function request(year, month, day) {
            const route = `/api/citas/${year}/${month}/${day}`
            $.ajax({
                url: route,
                async: false,
                success: function(resultado) {
                    console.log('Request complete!')
                    if (resultado.length == 0) {
                        console.log('No hay citas para esta fecha')
                    }
                    console.log(resultado)
                    console.log(resultado[0]['Nombres'])
                    console.log(resultado[0]['Apellido_Paterno'])
                    console.log(resultado[0]['Apellido_Paterno'])
                    for (let key in resultado[0]) {
                        document.getElementById('texto').innerHTML += `${key}: ${resultado[0][key]} \n`
                    }

                },
                error: function(jqXHR, exception) {
                    if (jqXHR.status === 0) {
                        alert('Not connect.\n Verify Network.');
                    } else if (jqXHR.status == 404) {
                        alert('Requested page not found. [404]');
                    } else if (jqXHR.status == 500) {
                        alert('Internal Server Error [500].');
                    } else if (exception === 'parsererror') {
                        alert('Requested JSON parse failed.');
                    } else if (exception === 'timeout') {
                        alert('Time out error.');
                    } else if (exception === 'abort') {
                        alert('Ajax request aborted.');
                    } else {
                        alert('Uncaught Error.\n' + jqXHR.responseText);
                    }
                }
            })
        }

        //
        $.fn.datepicker.dates['es'] = {
            days: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
            daysShort: ['Dom','Lun','Mar','Mié','Juv','Vie','Sáb'],
            daysMin: ['Do','Lu','Ma','Mi','Ju','Vi','Sá'],
            months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
            monthsShort: ['Ene','Feb','Mar','Abr', 'May','Jun','Jul','Ago','Sep', 'Oct','Nov','Dic'],
            today: 'Hoy',
            clear: 'Limpiar',
            format: 'dd/mm/yy',
            titleFormat: "MM yyyy", 
            weekStart: 1
        };
        // inicializar el datepicker
        $('#select-fecha').datepicker({
            autoclose: true,
            language: 'es-419',
            todayHighlight: true,   
            keepEmptyValues: true,
            todayBtn: true,
            changeMonth: true,
            changeYear: true,
            keyboardNavigation: false,  
            maxViewMode: 'days',
            daysOfWeekHighlighted: [selectDia.value],
            beforeShowDay : function(date) {
                return date.getDay() == selectDia.value
            },
            startDate: new Date(new Date().getFullYear(), new Date().getMonth() - 2, 1),
            endDate: new Date(),
            format : 'yyyy-mm-dd'
        });
        // configurar evento para validar cuando se cambia la fecha
        $('#select-fecha').datepicker().on('changeDate', function(e){
            console.log(e)
            if (e.date == null || e.date.getDay() != selectDia.value) {
                console.log('La fecha es inválida')
                fechaState = false
                $('#select-fecha').addClass('is-invalid').removeClass('is-valid')
            } else {
                fechaState = true
                $('#select-fecha').addClass('is-valid').removeClass('is-invalid')
            }
        });
        //
    });
</script>
{% endblock %}